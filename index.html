<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>SmartTools Pro ‚Äî Gest√£o & Disparos Seguros</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #1e3a8a; --accent: #2563eb; --whatsapp: #25D366;
            --danger: #ef4444; --warning: #f59e0b; --bg: #f8fafc; --card: #ffffff;
            --gray-light: #f1f5f9;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding-top: 90px; color: #1e293b; }
        
        /* Barra de Trava de Seguran√ßa Refor√ßada */
        #safety-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 75px;
            background: #111; color: white; display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 1000; font-weight: bold; transition: background 0.5s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #safety-bar.locked { background: var(--danger); }
        #safety-bar.safe { background: var(--whatsapp); }
        #safety-sub { font-size: 11px; opacity: 0.9; font-weight: normal; margin-top: 2px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Navega√ß√£o */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; background: #e2e8f0; padding: 5px; border-radius: 10px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #64748b; transition: 0.2s; }
        .tab-btn.active { background: var(--card); color: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .tab-content { display: none; background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; }

        /* Ferramentas de Texto (Novo) */
        .editor-toolbar {
            background: var(--gray-light); padding: 15px; border-radius: 8px 8px 0 0; border: 1px solid #cbd5e1; border-bottom: none;
        }
        .var-builder { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
        .var-input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; flex: 1; font-size: 13px; min-width: 100px; }
        .tag-btn { background: #e2e8f0; border: 1px solid #cbd5e1; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 12px; font-weight: bold; color: #475569; }
        .tag-btn:hover { background: #cbd5e1; }
        .btn-insert { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold; }

        textarea#msg_template {
            border-radius: 0 0 8px 8px; border-top: 1px solid #e2e8f0; margin-top: 0;
        }

        /* Filtros e Grid */
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; background: #f1f5f9; padding: 15px; border-radius: 8px; }
        label { display: block; font-size: 11px; font-weight: bold; text-transform: uppercase; color: #64748b; margin-bottom: 5px; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; box-sizing: border-box; }

        /* Tabela */
        .table-wrap { overflow-x: auto; max-height: 550px; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8fafc; padding: 12px; text-align: left; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        tr:hover { background: #fdfdfd; }
        tr.status-pago { background: #f0fdf4 !important; }
        tr.status-enviado { background: #fffbeb !important; }

        /* Relat√≥rio */
        .report-page { background: white; padding: 40px; border: 1px solid #ddd; max-width: 800px; margin: 0 auto; min-height: 600px; }
        .report-header { border-bottom: 3px solid var(--primary); margin-bottom: 25px; padding-bottom: 10px; }
        .metrics-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .m-card { border: 1px solid #e2e8f0; padding: 15px; text-align: center; border-radius: 4px; }
        .m-card span { font-size: 10px; color: #64748b; font-weight: bold; display: block; margin-bottom: 5px; }
        .m-card strong { font-size: 17px; color: var(--primary); }

        /* Bot√µes */
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-whatsapp { background: var(--whatsapp); color: white; text-decoration: none; font-size: 11px; padding: 6px 10px; }
        .btn-danger { background: var(--danger); color: white; }
        
        @media print {
            body { padding: 0; background: white; }
            .tab-nav, .filter-grid, #safety-bar, .btn, .tab-btn, .editor-toolbar, .table-wrap { display: none !important; }
            .report-page { border: none; width: 100%; margin: 0; padding: 0; }
        }
    </style>
</head>
<body>

    <div id="safety-bar" class="safe">
        <div id="safety-main">‚úÖ SISTEMA PRONTO PARA DISPAROS</div>
        <div id="safety-sub">Modo Seguro Web Ativo ‚Ä¢ Sess√£o Atual: 0 envios</div>
    </div>

    <div class="container">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-import')">1. Configurar & Importar</button>
            <button class="tab-btn" onclick="switchTab('tab-manage')">2. Gest√£o & Disparos</button>
            <button class="tab-btn" onclick="switchTab('tab-report')">3. Relat√≥rio Executivo</button>
        </div>

        <div id="tab-import" class="tab-content active">
            <h2>Configurar Campanha Anti-Ban</h2>
            
            <label style="margin-bottom: 8px;">Construtor de Mensagem:</label>
            
            <div class="editor-toolbar">
                <div style="margin-bottom: 8px; font-size: 11px; font-weight: bold; color: #64748b;">VARI√ÅVEIS DE SISTEMA</div>
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <button class="tag-btn" onclick="insertAtCursor('[NOME]')">üë§ Nome do Cliente</button>
                    <button class="tag-btn" onclick="insertAtCursor('[UNIDADE]')">üè¢ Unidade</button>
                </div>

                <div style="margin-bottom: 8px; font-size: 11px; font-weight: bold; color: #64748b;">CRIAR VARIA√á√ÉO (SIN√îNIMOS)</div>
                <div class="var-builder">
                    <input type="text" class="var-input" id="v1" placeholder="Op√ß√£o A (ex: Ol√°)">
                    <input type="text" class="var-input" id="v2" placeholder="Op√ß√£o B (ex: Oi)">
                    <input type="text" class="var-input" id="v3" placeholder="Op√ß√£o C (ex: Sauda√ß√µes)">
                    <button class="btn-insert" onclick="createVariation()">‚ûï Inserir Varia√ß√£o</button>
                </div>
                <small style="color: #64748b; font-size: 11px;">*Preencha 2 ou 3 campos para criar op√ß√µes que o sistema alterna automaticamente.</small>
            </div>
            
            <textarea id="msg_template" rows="4">{Ol√°|Oi|Sauda√ß√µes} [NOME], referente √† unidade [UNIDADE]. {Tudo bem?|Como vai?|Podemos conversar?}</textarea>
            
            <div style="background: #f1f5f9; padding: 20px; border-radius: 10px; border: 2px dashed #cbd5e1; text-align: center; margin-top: 15px;">
                <input type="file" id="csv_file" accept=".csv" style="margin-bottom: 10px;">
                <p style="font-size: 12px; color: #64748b;">Arquivo CSV (separado por ;) colunas: ID; Nome; Telefone; Unidade; Tipo</p>
            </div>
            
            <button onclick="processCSV()" class="btn btn-primary" style="width: 100%; margin-top: 20px; justify-content: center;">üöÄ Processar e Sincronizar</button>
        </div>

        <div id="tab-manage" class="tab-content">
            <div class="filter-grid">
                <div><label>Unidade:</label><select id="f_unidade" onchange="renderTable()"><option value="">Todas</option></select></div>
                <div><label>Tipo:</label><select id="f_tipo" onchange="renderTable()"><option value="">Todos</option></select></div>
                <div><label>Status:</label>
                    <select id="f_status" onchange="renderTable()">
                        <option value="">Todos</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Enviado">Enviado</option>
                        <option value="Pago">Pago</option>
                        <option value="Contato inv√°lido">Inv√°lido</option>
                    </select>
                </div>
                <div style="display:flex; align-items:flex-end;">
                    <button onclick="bulkDelete()" class="btn btn-danger">üóëÔ∏è Apagar Selecionados</button>
                </div>
            </div>

            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" onclick="toggleAll(this)"></th>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Unidade</th>
                            <th>Disparo Seguro</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="table_body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-report" class="tab-content">
            <div class="filter-grid" style="background: white; border: 1px solid #e2e8f0;">
                <div><label>Filtrar Unidade:</label><select id="rep_unidade" onchange="updateReport()"></select></div>
                <div><label>Ticket M√©dio (R$):</label><input type="number" id="rep_ticket" value="70.00" onchange="updateReport()"></div>
                <div style="display:flex; align-items:flex-end;"><button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Gerar PDF</button></div>
            </div>

            <div class="report-page" id="report_area">
                <div class="report-header">
                    <h1 style="margin:0; color: var(--primary);">Smart Tools</h1>
                    <p style="margin:5px 0; font-weight: bold;">RELAT√ìRIO FINANCEIRO EXECUTIVO</p>
                </div>
                <div id="rep_meta" style="font-size: 13px; margin-bottom: 20px;"></div>
                <div class="metrics-row" id="rep_metrics"></div>
                <div id="rep_text" style="font-size: 14px; line-height: 1.6; margin-bottom: 30px;"></div>
                <h3 style="border-left: 4px solid var(--accent); padding-left: 10px; font-size: 16px;">An√°lise Probabil√≠stica</h3>
                <table style="width: 100%; margin-top: 15px; border: 1px solid #eee;">
                    <thead><tr style="background: #f8fafc;"><th>Cen√°rio</th><th>Probabilidade</th><th>Convers√£o</th><th>Receita</th></tr></thead>
                    <tbody id="rep_scenarios"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDiZQeKce5CUFGrY7UpkyZzBvem-5PFo1Y",
            authDomain: "disparador-ddb0c.firebaseapp.com",
            projectId: "disparador-ddb0c",
            storageBucket: "disparador-ddb0c.firebasestorage.app",
            messagingSenderId: "158046191374",
            appId: "1:158046191374:web:80d6fb6888f64ded4de15f",
            measurementId: "G-4JZPJ3YDFL"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let rawData = [];
        let isLocked = false;
        let sessionCount = 0;

        // --- GERADOR DE TEXTO E INTERFACE ---
        
        // Insere texto onde o cursor est√° (melhora UX)
        function insertAtCursor(text) {
            const input = document.getElementById('msg_template');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            
            input.value = value.substring(0, start) + text + value.substring(end);
            input.selectionStart = input.selectionEnd = start + text.length;
            input.focus();
        }

        // Cria a varia√ß√£o {a|b|c} baseada nos inputs
        function createVariation() {
            const v1 = document.getElementById('v1').value.trim();
            const v2 = document.getElementById('v2').value.trim();
            const v3 = document.getElementById('v3').value.trim();
            
            const options = [v1, v2, v3].filter(v => v !== "");
            
            if(options.length < 2) {
                return alert("Preencha pelo menos 2 campos para criar uma varia√ß√£o.");
            }
            
            const tag = `{${options.join('|')}}`;
            insertAtCursor(tag);
            
            // Limpa campos ap√≥s inserir
            document.getElementById('v1').value = "";
            document.getElementById('v2').value = "";
            document.getElementById('v3').value = "";
        }

        // Processa o texto final com Spintax
        function spinText(text) {
            return text.replace(/\{([^{}]+)\}/g, function(match, content) {
                const choices = content.split('|');
                return choices[Math.floor(Math.random() * choices.length)];
            });
        }

        // --- SISTEMA DE ABAS ---
        function switchTab(id) {
            document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`[onclick="switchTab('${id}')"]`).classList.add('active');
            if(id !== 'tab-import') loadFromFirebase();
        }

        // --- PROCESSAMENTO CSV ---
        function processCSV() {
            const file = document.getElementById('csv_file').files[0];
            const template = document.getElementById('msg_template').value;
            if(!file) return alert("Selecione o arquivo CSV.");

            const reader = new FileReader();
            reader.readAsText(file, 'ISO-8859-1'); 
            
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/); 
                const batch = [];

                lines.forEach((line, i) => {
                    if(i === 0 || !line.trim()) return;
                    const c = line.split(';');
                    if(c.length >= 5) {
                        const id = c[0].trim();
                        const nome = c[1].trim();
                        const tel = c[2].replace(/\D/g,'');
                        const unidade = c[3].trim();
                        const tipo = c[4].trim();
                        
                        // 1. Vari√°veis fixas
                        let msgBase = template.replace('[NOME]', nome).replace('[UNIDADE]', unidade);
                        // 2. Varia√ß√£o de Spintax
                        let msgFinal = spinText(msgBase);
                        // 3. Hash invis√≠vel √∫nico
                        msgFinal += '\u200B'.repeat(Math.floor(Math.random() * 5)); 

                        const link = `https://wa.me/${tel.startsWith('55')?tel:'55'+tel}?text=${encodeURIComponent(msgFinal)}`;
                        
                        batch.push({
                            id, nome, telefone: tel, unidade, tipo, status: 'Pendente',
                            link: link, selected: false, timestamp: Date.now()
                        });
                    }
                });

                if(batch.length > 0) saveToFirebase(batch);
                else alert("CSV inv√°lido ou vazio.");
            };
        }

        async function saveToFirebase(data) {
            const btn = document.querySelector('[onclick="processCSV()"]');
            btn.innerText = "‚è≥ Sincronizando...";
            let count = 0;
            for (const item of data) {
                await db.collection("contatos").doc(item.id).set(item);
                count++;
                if(count % 10 === 0) btn.innerText = `‚è≥ Salvando ${count}/${data.length}`;
            }
            alert("Importa√ß√£o conclu√≠da com sucesso!");
            switchTab('tab-manage');
        }

        async function loadFromFirebase() {
            const snap = await db.collection("contatos").orderBy("nome").get();
            rawData = snap.docs.map(doc => doc.data());
            updateFiltersUI();
            renderTable();
            updateReport();
        }

        // --- SEGURAN√áA E DISPARO ---
        function handleSend(id) {
            if(isLocked) { event.preventDefault(); return alert("‚ö†Ô∏è AGUARDE O CONTADOR DE SEGURAN√áA!"); }

            sessionCount++;
            updateStatus(id, 'Enviado');
            
            // Delay din√¢mico (45s a 90s)
            const delay = Math.floor(Math.random() * (90 - 45 + 1)) + 45;
            startSafetyTimer(delay);

            if(sessionCount % 15 === 0) {
                setTimeout(() => alert("üõë ALERTA ANTI-BAN: 15 envios realizados. Pause por 5 minutos."), 2000);
            }
        }

        function startSafetyTimer(s) {
            isLocked = true;
            const bar = document.getElementById('safety-bar');
            bar.className = 'locked';
            let t = s;
            const int = setInterval(() => {
                document.getElementById('safety-main').innerText = `‚è≥ PROTE√á√ÉO WEB: AGUARDE ${t}s`;
                document.getElementById('safety-sub').innerText = `Sess√£o: ${sessionCount} envios`;
                t--;
                if(t < 0) { 
                    clearInterval(int); isLocked = false; 
                    bar.className = 'safe'; 
                    document.getElementById('safety-main').innerText = "‚úÖ PRONTO PARA ENVIAR";
                }
            }, 1000);
        }

        // --- UI AUXILIAR ---
        function updateFiltersUI() {
            const unidades = [...new Set(rawData.map(i => i.unidade))].sort();
            fillSelect('f_unidade', unidades, "Todas");
            fillSelect('rep_unidade', unidades, null);
            fillSelect('f_tipo', [...new Set(rawData.map(i => i.tipo))].sort(), "Todos");
        }
        function fillSelect(id, list, first) {
            const el = document.getElementById(id);
            const cur = el.value;
            el.innerHTML = first ? `<option value="">${first}</option>` : '';
            list.forEach(i => { if(i) el.innerHTML += `<option value="${i}">${i}</option>`; });
            if(cur) el.value = cur;
        }
        function renderTable() {
            const fUni = document.getElementById('f_unidade').value;
            const fStat = document.getElementById('f_status').value;
            const tbody = document.getElementById('table_body');
            tbody.innerHTML = '';
            
            rawData.filter(i => (!fUni || i.unidade === fUni) && (!fStat || i.status === fStat))
            .forEach(item => {
                const tr = document.createElement('tr');
                tr.className = item.status === 'Pago' ? 'status-pago' : (item.status === 'Enviado' ? 'status-enviado' : '');
                tr.innerHTML = `
                    <td><input type="checkbox" ${item.selected?'checked':''} onchange="toggleSelect('${item.id}')"></td>
                    <td>${item.id}</td><td><strong>${item.nome}</strong></td><td>${item.unidade}</td>
                    <td><a href="${item.link}" target="_blank" class="btn btn-whatsapp" onclick="handleSend('${item.id}')">üì± ENVIAR</a></td>
                    <td><select onchange="updateStatus('${item.id}', this.value)">
                        <option value="Pendente" ${item.status==='Pendente'?'selected':''}>Pendente</option>
                        <option value="Enviado" ${item.status==='Enviado'?'selected':''}>Enviado</option>
                        <option value="Pago" ${item.status==='Pago'?'selected':''}>Pago</option>
                    </select></td>`;
                tbody.appendChild(tr);
            });
        }
        async function updateStatus(id, st) {
            const idx = rawData.findIndex(x => x.id === id);
            if(idx !== -1) { rawData[idx].status = st; await db.collection("contatos").doc(id).update({status: st}); renderTable(); }
        }
        function toggleSelect(id) { const i = rawData.find(x => x.id === id); if(i) i.selected = !i.selected; }
        function toggleAll(src) { rawData.forEach(i => i.selected = src.checked); renderTable(); }
        async function bulkDelete() {
            if(!confirm("Excluir selecionados?")) return;
            for(const i of rawData.filter(x => x.selected)) await db.collection("contatos").doc(i.id).delete();
            loadFromFirebase();
        }
        function updateReport() {
             /* Mesma l√≥gica de relat√≥rio anterior */
             const uni = document.getElementById('rep_unidade').value;
             const ticket = document.getElementById('rep_ticket').value;
             const data = rawData.filter(i => i.unidade === uni);
             if(!data.length) return;
             const total = data.length;
             const pagos = data.filter(i => i.status === 'Pago').length;
             document.getElementById('rep_meta').innerHTML = `Unidade: ${uni}`;
             document.getElementById('rep_metrics').innerHTML = `<div class="m-card"><span>Pagos</span><strong>${pagos}/${total}</strong></div>`;
        }

        window.onload = loadFromFirebase;
    </script>
</body>
</html>
