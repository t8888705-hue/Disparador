<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>SmartTools Pro ‚Äî Gest√£o & Relat√≥rios</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #0f172a; --accent: #2563eb; --whatsapp: #25D366;
            --danger: #ef4444; --bg: #f1f5f9; --card: #ffffff;
            --border: #e2e8f0;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding-top: 90px; color: #334155; }
        
        /* BARRA DE SEGURAN√áA */
        #safety-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 70px;
            background: #1e293b; color: white; display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 1000; font-weight: bold; transition: background 0.5s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #safety-bar.locked { background: var(--danger); }
        #safety-bar.safe { background: var(--whatsapp); }
        #safety-sub { font-size: 11px; opacity: 0.9; font-weight: normal; margin-top: 2px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* NAVEGA√á√ÉO */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; background: #e2e8f0; padding: 5px; border-radius: 10px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #64748b; transition: 0.2s; }
        .tab-btn.active { background: var(--card); color: var(--accent); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .tab-content { display: none; background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; }

        /* INPUTS E BOT√ïES GERAIS */
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-whatsapp { background: var(--whatsapp); color: white; text-decoration: none; font-size: 11px; padding: 6px 10px; border-radius: 4px; }
        .btn-danger { background: var(--danger); color: white; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        .editor-toolbar { background: #f8fafc; padding: 15px; border: 1px solid var(--border); border-radius: 8px 8px 0 0; border-bottom: none; }
        textarea#msg_template { border-radius: 0 0 8px 8px; border-top: 1px solid var(--border); margin-top: 0; min-height: 120px; }

        /* TABLE GEST√ÉO */
        .table-wrap { overflow-x: auto; max-height: 550px; border: 1px solid var(--border); border-radius: 8px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8fafc; padding: 12px; text-align: left; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border); color: #475569; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        tr.status-pago { background: #f0fdf4 !important; }
        tr.status-enviado { background: #fffbeb !important; }

        /* --- RELAT√ìRIO EXECUTIVO (CSS ESPEC√çFICO) --- */
        .report-page { 
            background: white; width: 100%; max-width: 210mm; min-height: 297mm; margin: 0 auto; 
            padding: 40px; box-sizing: border-box; border: 1px solid #ddd; position: relative;
        }
        
        .rep-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px; }
        .rep-logo h1 { margin: 0; color: var(--primary); font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
        .rep-logo span { font-size: 12px; color: #64748b; letter-spacing: 2px; text-transform: uppercase; }
        .rep-meta { text-align: right; font-size: 12px; color: #64748b; }
        .rep-meta strong { color: #000; font-size: 14px; display: block; margin-bottom: 2px; }

        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .kpi-card { border: 1px solid var(--border); padding: 15px; border-radius: 6px; text-align: center; background: #fff; }
        .kpi-card span { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: bold; display: block; margin-bottom: 5px; }
        .kpi-card strong { font-size: 20px; color: var(--primary); display: block; }
        .kpi-card small { font-size: 11px; color: var(--whatsapp); font-weight: bold; }

        .section-title { background: #f1f5f9; padding: 8px 15px; font-size: 12px; font-weight: bold; text-transform: uppercase; color: #475569; margin: 20px 0 10px 0; border-left: 4px solid var(--accent); }

        .rep-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px; }
        .rep-table th { background: var(--primary); color: white; padding: 8px 12px; text-align: left; font-size: 11px; text-transform: uppercase; }
        .rep-table td { padding: 8px 12px; border-bottom: 1px solid #e2e8f0; color: #334155; }
        .rep-table tr:nth-child(even) { background: #f8fafc; }
        
        .progress-bar { background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; width: 100%; }
        .progress-fill { height: 100%; background: var(--accent); }

        .footer { position: absolute; bottom: 40px; left: 40px; right: 40px; border-top: 1px solid #ddd; padding-top: 10px; font-size: 10px; color: #94a3b8; display: flex; justify-content: space-between; }

        /* CONFIGURA√á√ÉO DE IMPRESS√ÉO */
        @media print {
            body { padding: 0; background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #safety-bar, .tab-nav, .filter-input-area, .no-print { display: none !important; }
            .container { max-width: 100%; margin: 0; padding: 0; }
            .tab-content { padding: 0; border: none; shadow: none; display: none; }
            #tab-report { display: block !important; }
            .report-page { border: none; width: 100%; margin: 0; padding: 20px; max-width: 100%; min-height: auto; }
            .kpi-card, .section-title, th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div id="safety-bar" class="safe">
        <div id="safety-main">‚úÖ SISTEMA PRONTO PARA DISPAROS</div>
        <div id="safety-sub">Modo Seguro Web Ativo ‚Ä¢ Sess√£o Atual: 0 envios</div>
    </div>

    <div class="container">
        <div class="tab-nav no-print">
            <button class="tab-btn active" onclick="switchTab('tab-import')">1. Configurar & Importar</button>
            <button class="tab-btn" onclick="switchTab('tab-manage')">2. Gest√£o & Disparos</button>
            <button class="tab-btn" onclick="switchTab('tab-report')">3. Relat√≥rio Executivo</button>
        </div>

        <div id="tab-import" class="tab-content active">
            <h2>Configurar Campanha Anti-Ban</h2>
            <div class="editor-toolbar">
                <small style="font-weight: bold; color: #64748b;">VARI√ÅVEIS: [NOME] [UNIDADE] ‚Ä¢ Use {Ol√°|Oi} para variar.</small>
            </div>
            <textarea id="msg_template" placeholder="Digite sua mensagem aqui...">{Ol√°|Oi} [NOME], somos da [UNIDADE]. {Tudo bem?|Podemos falar?}</textarea>
            
            <div style="background: #f8fafc; padding: 20px; margin-top: 15px; border: 2px dashed #cbd5e1; text-align: center;">
                <input type="file" id="csv_file" accept=".csv">
                <p style="font-size: 12px; color: #64748b; margin-top: 5px;">CSV: ID; Nome; Telefone; Unidade; Tipo</p>
            </div>
            <button onclick="processCSV()" class="btn btn-primary" style="width: 100%; margin-top: 20px; justify-content: center;">üöÄ Processar e Sincronizar</button>
        </div>

        <div id="tab-manage" class="tab-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                <select id="f_unidade" onchange="renderTable()"><option value="">Todas Unidades</option></select>
                <select id="f_status" onchange="renderTable()">
                    <option value="">Todos Status</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Enviado">Enviado</option>
                    <option value="Pago">Pago</option>
                </select>
                <button onclick="bulkDelete()" class="btn btn-danger" style="font-size: 12px;">üóëÔ∏è Excluir Selecionados</button>
            </div>

            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th width="30"><input type="checkbox" onclick="toggleAll(this)"></th>
                            <th>Nome</th>
                            <th>Unidade</th>
                            <th>A√ß√£o</th>
                            <th>Status Financeiro</th>
                        </tr>
                    </thead>
                    <tbody id="table_body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-report" class="tab-content">
            <div class="filter-input-area no-print" style="background: #f8fafc; padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; gap: 15px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label style="font-size: 11px; font-weight: bold; text-transform: uppercase;">Selecionar Unidade</label>
                    <select id="rep_unidade" onchange="updateReport()"></select>
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 11px; font-weight: bold; text-transform: uppercase;">Ticket M√©dio (R$)</label>
                    <input type="number" id="rep_ticket" value="99.90" onchange="updateReport()">
                </div>
                <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Baixar PDF / Imprimir</button>
            </div>

            <div class="report-page">
                <div class="rep-header">
                    <div class="rep-logo">
                        <h1>Smart Tools Pro</h1>
                        <span>Relat√≥rio de Performance</span>
                    </div>
                    <div class="rep-meta">
                        <span id="rep_date">Data: --/--/----</span>
                        <strong id="rep_unit_display">UNIDADE: GERAL</strong>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <span>Base Total (Leads)</span>
                        <strong id="kpi_leads">0</strong>
                    </div>
                    <div class="kpi-card">
                        <span>Contatos Realizados</span>
                        <strong id="kpi_contatos">0</strong>
                        <small id="kpi_perc_contato">0% da base</small>
                    </div>
                    <div class="kpi-card">
                        <span>Vendas (Pagos)</span>
                        <strong id="kpi_vendas" style="color: var(--whatsapp);">0</strong>
                        <small id="kpi_conversao">0% Conv.</small>
                    </div>
                    <div class="kpi-card">
                        <span>Faturamento Atual</span>
                        <strong id="kpi_faturamento" style="color: var(--primary);">R$ 0,00</strong>
                    </div>
                </div>

                <div class="section-title">An√°lise de Funil & Efici√™ncia</div>
                <table class="rep-table">
                    <thead><tr><th>Etapa do Funil</th><th>Quantidade</th><th>Representatividade</th><th>Visual</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>1. Base Carregada</td>
                            <td id="funnel_total">0</td>
                            <td>100%</td>
                            <td><div class="progress-bar"><div class="progress-fill" style="width: 100%; background: #94a3b8;"></div></div></td>
                        </tr>
                        <tr>
                            <td>2. Abordados (Enviados)</td>
                            <td id="funnel_env">0</td>
                            <td id="funnel_env_perc">0%</td>
                            <td><div class="progress-bar"><div class="progress-fill" id="bar_env" style="width: 0%; background: var(--accent);"></div></div></td>
                        </tr>
                        <tr>
                            <td>3. Convertidos (Pagos)</td>
                            <td id="funnel_pago">0</td>
                            <td id="funnel_pago_perc">0%</td>
                            <td><div class="progress-bar"><div class="progress-fill" id="bar_pago" style="width: 0%; background: var(--whatsapp);"></div></div></td>
                        </tr>
                    </tbody>
                </table>

                <div class="section-title">Cen√°rios de Faturamento (Proje√ß√£o)</div>
                <p style="font-size: 12px; margin-bottom: 10px; color: #64748b;">
                    *C√°lculo baseado no Ticket M√©dio de <b id="txt_ticket">R$ 0,00</b> aplicado sobre os leads pendentes.
                </p>
                <table class="rep-table">
                    <thead>
                        <tr>
                            <th>Cen√°rio</th>
                            <th>Taxa Estimada</th>
                            <th>Novas Vendas (Est.)</th>
                            <th>Receita Adicional</th>
                            <th>Receita Total (Prevista)</th>
                        </tr>
                    </thead>
                    <tbody id="scenario_body">
                        </tbody>
                </table>

                <div class="footer">
                    <span>Gerado por SmartTools System</span>
                    <span>Documento Confidencial</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG FIREBASE (MANTIDA IGUAL) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDiZQeKce5CUFGrY7UpkyZzBvem-5PFo1Y",
            authDomain: "disparador-ddb0c.firebaseapp.com",
            projectId: "disparador-ddb0c",
            storageBucket: "disparador-ddb0c.firebasestorage.app",
            messagingSenderId: "158046191374",
            appId: "1:158046191374:web:80d6fb6888f64ded4de15f",
            measurementId: "G-4JZPJ3YDFL"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let rawData = [];
        let isLocked = false;
        let sessionCount = 0;

        // --- SISTEMA ---
        function switchTab(id) {
            document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`[onclick="switchTab('${id}')"]`).classList.add('active');
            if(id !== 'tab-import') loadFromFirebase();
        }

        function spinText(text) {
            return text.replace(/\{([^{}]+)\}/g, (match, content) => {
                const choices = content.split('|');
                return choices[Math.floor(Math.random() * choices.length)];
            });
        }

        // --- IMPORTA√á√ÉO ---
        function processCSV() {
            const file = document.getElementById('csv_file').files[0];
            const template = document.getElementById('msg_template').value;
            if(!file) return alert("Selecione o arquivo CSV.");

            const reader = new FileReader();
            reader.readAsText(file, 'ISO-8859-1'); 
            
            reader.onload = function(e) {
                const lines = e.target.result.split(/\r?\n/);
                const batch = [];
                lines.forEach((line, i) => {
                    if(i === 0 || !line.trim()) return;
                    const c = line.split(';');
                    if(c.length >= 5) {
                        const tel = c[2].replace(/\D/g,'');
                        let msg = template.replace('[NOME]', c[1]).replace('[UNIDADE]', c[3]);
                        msg = spinText(msg) + '\u200B'.repeat(Math.floor(Math.random()*5));
                        
                        batch.push({
                            id: c[0].trim(), nome: c[1].trim(), telefone: tel, unidade: c[3].trim(), tipo: c[4].trim(),
                            status: 'Pendente', link: `https://wa.me/${tel.startsWith('55')?tel:'55'+tel}?text=${encodeURIComponent(msg)}`,
                            selected: false, timestamp: Date.now()
                        });
                    }
                });
                if(batch.length) saveToFirebase(batch);
            };
        }

        async function saveToFirebase(data) {
            const btn = document.querySelector('[onclick="processCSV()"]');
            btn.innerText = "‚è≥ Sincronizando...";
            let c = 0;
            for (const item of data) {
                await db.collection("contatos").doc(item.id).set(item);
                c++;
                if(c % 20 === 0) btn.innerText = `Salvo: ${c}/${data.length}`;
            }
            alert("Sucesso!");
            btn.innerText = "üöÄ Processar e Sincronizar";
            switchTab('tab-manage');
        }

        async function loadFromFirebase() {
            const snap = await db.collection("contatos").get();
            rawData = snap.docs.map(doc => doc.data());
            
            // Popula filtros
            const units = [...new Set(rawData.map(i => i.unidade))].sort();
            const popSelect = (id, list) => {
                const el = document.getElementById(id);
                const val = el.value;
                el.innerHTML = '<option value="">Todas / Geral</option>';
                list.forEach(u => el.innerHTML += `<option value="${u}">${u}</option>`);
                el.value = val;
            };
            popSelect('f_unidade', units);
            popSelect('rep_unidade', units);
            
            renderTable();
            updateReport();
        }

        // --- GEST√ÉO ---
        function renderTable() {
            const fUni = document.getElementById('f_unidade').value;
            const fStat = document.getElementById('f_status').value;
            const tbody = document.getElementById('table_body');
            tbody.innerHTML = '';
            
            rawData.filter(i => (!fUni || i.unidade === fUni) && (!fStat || i.status === fStat))
            .forEach(item => {
                const tr = document.createElement('tr');
                tr.className = item.status === 'Pago' ? 'status-pago' : (item.status === 'Enviado' ? 'status-enviado' : '');
                tr.innerHTML = `
                    <td><input type="checkbox" ${item.selected?'checked':''} onchange="toggleSelect('${item.id}')"></td>
                    <td>${item.nome}</td>
                    <td>${item.unidade}</td>
                    <td><a href="${item.link}" target="_blank" class="btn btn-whatsapp" onclick="handleSend('${item.id}')">üì± ENVIAR</a></td>
                    <td><select onchange="updateStatus('${item.id}', this.value)" style="padding:5px; height:auto;">
                        <option value="Pendente" ${item.status==='Pendente'?'selected':''}>Pendente</option>
                        <option value="Enviado" ${item.status==='Enviado'?'selected':''}>Enviado</option>
                        <option value="Pago" ${item.status==='Pago'?'selected':''}>üí∞ Pago</option>
                    </select></td>`;
                tbody.appendChild(tr);
            });
        }

        async function updateStatus(id, st) {
            const idx = rawData.findIndex(x => x.id === id);
            if(idx !== -1) { 
                rawData[idx].status = st; 
                await db.collection("contatos").doc(id).update({status: st}); 
                renderTable(); 
                updateReport(); // Atualiza relat√≥rio em tempo real
            }
        }

        function handleSend(id) {
            if(isLocked) { event.preventDefault(); return alert("Aguarde o timer de seguran√ßa!"); }
            sessionCount++;
            updateStatus(id, 'Enviado');
            
            // L√≥gica Anti-Ban
            isLocked = true;
            const bar = document.getElementById('safety-bar');
            bar.className = 'locked';
            let t = Math.floor(Math.random() * (60 - 30 + 1)) + 30; // 30 a 60s
            
            const int = setInterval(() => {
                document.getElementById('safety-main').innerText = `‚è≥ AGUARDE ${t}s PARA PR√ìXIMO ENVIO`;
                document.getElementById('safety-sub').innerText = `Sess√£o: ${sessionCount}`;
                t--;
                if(t < 0) { 
                    clearInterval(int); isLocked = false; bar.className = 'safe'; 
                    document.getElementById('safety-main').innerText = "‚úÖ SISTEMA PRONTO";
                }
            }, 1000);
        }

        function toggleSelect(id) { const i = rawData.find(x => x.id === id); if(i) i.selected = !i.selected; }
        function toggleAll(src) { rawData.forEach(i => i.selected = src.checked); renderTable(); }
        async function bulkDelete() {
            if(!confirm("Tem certeza?")) return;
            const sel = rawData.filter(x => x.selected);
            for(const i of sel) await db.collection("contatos").doc(i.id).delete();
            loadFromFirebase();
        }

        // --- L√ìGICA DO RELAT√ìRIO FINANCEIRO (PDF) ---
        function updateReport() {
            const uni = document.getElementById('rep_unidade').value;
            const ticketVal = parseFloat(document.getElementById('rep_ticket').value) || 0;
            
            // Filtra Dados
            const data = uni ? rawData.filter(i => i.unidade === uni) : rawData;
            
            const total = data.length;
            if(total === 0) return; // Evita erros se vazio

            const enviados = data.filter(i => i.status === 'Enviado' || i.status === 'Pago').length;
            const pagos = data.filter(i => i.status === 'Pago').length;
            const pendentes = total - enviados; // Consideramos pendentes quem ainda n√£o recebeu msg ou n√£o pagou

            // C√°lculos
            const convRate = enviados > 0 ? (pagos / enviados) * 100 : 0;
            const faturamento = pagos * ticketVal;

            // Formata√ß√£o Moeda
            const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            // Atualiza UI Header e KPIs
            document.getElementById('rep_date').innerText = new Date().toLocaleDateString('pt-BR');
            document.getElementById('rep_unit_display').innerText = uni ? `UNIDADE: ${uni.toUpperCase()}` : "UNIDADE: GERAL (CONSOLIDADO)";
            
            document.getElementById('kpi_leads').innerText = total;
            document.getElementById('kpi_contatos').innerText = enviados;
            document.getElementById('kpi_perc_contato').innerText = ((enviados/total)*100).toFixed(1) + "% da base";
            document.getElementById('kpi_vendas').innerText = pagos;
            document.getElementById('kpi_conversao').innerText = convRate.toFixed(1) + "% Conv.";
            document.getElementById('kpi_faturamento').innerText = fmt(faturamento);
            document.getElementById('txt_ticket').innerText = fmt(ticketVal);

            // Atualiza Funil
            document.getElementById('funnel_total').innerText = total;
            document.getElementById('funnel_env').innerText = enviados;
            document.getElementById('funnel_env_perc').innerText = ((enviados/total)*100).toFixed(1) + "%";
            document.getElementById('bar_env').style.width = ((enviados/total)*100) + "%";

            document.getElementById('funnel_pago').innerText = pagos;
            document.getElementById('funnel_pago_perc').innerText = ((pagos/total)*100).toFixed(1) + "%";
            document.getElementById('bar_pago').style.width = ((pagos/total)*100) + "%";

            // Atualiza Cen√°rios (Pessimista: 50% da taxa atual, Realista: Atual, Otimista: 150% da atual)
            // Se taxa atual for 0, usamos uma base de 1% para simular
            const baseRate = convRate > 0 ? convRate : 1.0; 
            
            // Leads "trabalh√°veis" restantes (Pendentes + Enviados que n√£o pagaram? Vamos simplificar: Leads Totais - Pagos)
            // Mas para proje√ß√£o futura, usamos os PENDENTES de envio
            const leadsParaTrabalhar = total - enviados; 

            const scenarios = [
                { name: "Pessimista (Baixa Conv.)", rate: baseRate * 0.5 },
                { name: "Realista (Tend√™ncia Atual)", rate: baseRate },
                { name: "Otimista (Alta Performance)", rate: baseRate * 1.5 }
            ];

            const sBody = document.getElementById('scenario_body');
            sBody.innerHTML = '';

            scenarios.forEach(s => {
                const novasVendas = Math.floor(leadsParaTrabalhar * (s.rate / 100));
                const recAdicional = novasVendas * ticketVal;
                const recTotal = faturamento + recAdicional;

                sBody.innerHTML += `
                    <tr>
                        <td><strong>${s.name}</strong></td>
                        <td>${s.rate.toFixed(1)}%</td>
                        <td>+${novasVendas}</td>
                        <td style="color: #64748b;">+${fmt(recAdicional)}</td>
                        <td style="font-weight:bold; color: var(--primary);">${fmt(recTotal)}</td>
                    </tr>
                `;
            });
        }

        window.onload = loadFromFirebase;
    </script>
</body>
</html>
